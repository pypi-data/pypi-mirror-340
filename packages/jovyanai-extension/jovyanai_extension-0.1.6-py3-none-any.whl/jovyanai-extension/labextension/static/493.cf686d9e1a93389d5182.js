"use strict";(self.webpackChunk_jovyanai_labextension=self.webpackChunk_jovyanai_labextension||[]).push([[493],{755:(e,t,n)=>{n.r(t),n.d(t,{default:()=>L});var o=n(369),r=n(507),l=n(338),c=n(345),a=n.n(c);const i=({onClick:e,text:t})=>{const[n,o]=(0,c.useState)(!1),r=/Mac/i.test(navigator.userAgent),l=r?"⌘K":"^K",i=r?"Cmd+K":"Ctrl+K";return a().createElement("div",{className:"jv-cell-ai-button-container"},a().createElement("button",{className:"jv-cell-ai-button",title:`Generate code ${l}`,onClick:e,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1)},t," ",a().createElement("span",{style:{fontSize:"0.8em"}},l)),n&&a().createElement("div",{className:"jv-cell-ai-tooltip"},"Open the prompt box to instruct AI (",i,")"))},s=({onClick:e,text:t})=>{const[n,o]=(0,c.useState)(!1);return a().createElement("div",{className:"jv-cell-fix-error-container"},a().createElement("button",{className:"jv-cell-fix-error-button",title:"Fix Error ⇧F",onClick:e,onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1)},t," ",a().createElement("span",{style:{fontSize:"0.8em"}},"⇧F")),n&&a().createElement("div",{className:"jv-cell-fix-error-tooltip"},"Fix this error with AI (","Shift+F",")"))};var d=n(880);const u=({onClick:e,disabled:t=!1,className:n,children:o})=>a().createElement("button",{onClick:e,disabled:t,className:n||"jv-default-button",style:{cursor:t?"not-allowed":"pointer",opacity:t?.6:1}},o),m=({isEnabled:e,placeholderEnabled:t,placeholderDisabled:n,initialInput:o,onSubmit:r,onCancel:l})=>{const[i,s]=(0,c.useState)(o||""),m=a().useRef(null),h=()=>{var e;const t=(null===(e=m.current)||void 0===e?void 0:e.getValue())||i;""!==t.trim()&&(r(t),s(""))};return a().createElement("div",{className:"jv-cell-ai-input-container"},a().createElement("div",{className:"jv-cell-ai-input-editor"},a().createElement(d.Editor,{defaultLanguage:"markdown",theme:"true"===document.body.getAttribute("data-jp-theme-light")?"vs":"vs-dark",value:i,onChange:e=>{void 0!==e&&s(e)},onMount:(e,t)=>{m.current=e,e.onKeyDown((async t=>{(()=>{const t=e.getContainerDomNode().querySelector(".editor-widget.suggest-widget.visible");return null!==t&&"true"===t.getAttribute("monaco-visible-content-widget")})()||("Escape"===t.code&&(t.preventDefault(),l()),"Enter"===t.code&&(t.preventDefault(),t.shiftKey?e.trigger("keyboard","type",{text:"\n"}):h()))})),e.focus()},options:{minimap:{enabled:!1},lineNumbers:"off",glyphMargin:!1,folding:!1,wordWrap:"on",wrappingIndent:"same",automaticLayout:!0,scrollBeyondLastLine:!1,readOnly:!e,placeholder:e?t:n}})),a().createElement("div",{className:"jv-cell-ai-input-buttons"},a().createElement(u,{onClick:h,disabled:!e||""===i.trim(),className:"jv-cell-ai-input-submit-button"},"Submit",a().createElement("span",{style:{fontSize:"0.7em",marginLeft:"5px"}},"Enter")),a().createElement(u,{onClick:l,className:"jv-cell-ai-input-cancel-button"},"Cancel",a().createElement("span",{style:{fontSize:"0.7em",marginLeft:"5px"}},"Escape"))))};var h=n(24),p=n(195),v=n(963),g=n(576),C=n(608);const b=({onClick:e,className:t,text:n,shortcut:o,tooltip:r})=>{const[l,i]=(0,c.useState)(!1);return a().createElement("div",{className:"jv-cell-diff-review-button-container"},a().createElement("button",{onClick:e,className:t,onMouseEnter:()=>i(!0),onMouseLeave:()=>i(!1),title:`${n} ${o}`},n," ",a().createElement("span",{style:{fontSize:"0.7em"}},o)),l&&a().createElement("div",{className:"tooltip"},r,a().createElement("br",null),"Shortcut: ",a().createElement("strong",null,o)))},y=({buttonsRef:e,onAcceptAndRun:t,onAccept:n,onReject:o})=>((0,c.useEffect)((()=>{e.current&&e.current.focus({preventScroll:!0})}),[]),a().createElement("div",{className:"jv-diff-review-buttons-container",tabIndex:0,ref:e,onKeyDown:e=>{"Enter"===e.key?(e.preventDefault(),e.shiftKey||e.metaKey||e.ctrlKey?e.shiftKey&&document.querySelector(".accept-and-run-button").click():document.querySelector(".accept-button").click()):"m"===e.key&&(e.metaKey||e.ctrlKey)?(e.preventDefault(),document.querySelector(".edit-prompt-button").click()):"Escape"===e.key&&(e.preventDefault(),document.querySelector(".reject-button").click())},onBlur:()=>{e.current&&e.current.focus({preventScroll:!0})}},a().createElement(b,{onClick:t,className:"accept-and-run-button",text:"Accept & Run",shortcut:"Shift + Enter",tooltip:"Accept the changes and run the code in the current cell."}),a().createElement(b,{onClick:o,className:"reject-button",text:"Reject",shortcut:"Escape",tooltip:"Reject the changes and revert to the original code."}),a().createElement(b,{onClick:n,className:"accept-button",text:"Accept",shortcut:"Enter",tooltip:"Accept the changes and keep the code in the current cell."})));var f=n(989);const E=({activeCell:e,oldCode:t,generateCodeStream:n,acceptCodeHandler:o,rejectCodeHandler:r,editPromptHandler:l,acceptAndRunHandler:i})=>{const[s,d]=(0,c.useState)(null),[u,m]=(0,c.useState)(null),[b,E]=(0,c.useState)(""),[k,_]=(0,c.useState)(!1),[x,w]=(0,c.useState)("Thinking..."),S=(0,c.useRef)(null),[j,A]=(0,c.useState)(!1),I=(0,c.useRef)(null),N=(0,c.useRef)(!1);(0,c.useEffect)((()=>{if(e&&void 0!==t){const n=function(e,t,n,o=!1){const r=[(0,g.Hg)(),C.jupyterTheme,h.EditorView.editable.of(!1),p.EditorState.readOnly.of(!0),(0,h.highlightSpecialChars)()];o||r.push((0,v.unifiedMergeView)({original:t,mergeControls:!1,gutter:!1}));const l=new h.EditorView({state:p.EditorState.create({doc:n,extensions:r}),parent:e.editor.dom});return e.editor.dom.classList.add("hidden-editor"),o&&l.dom.classList.add("new-code-generation"),l.dom.classList.add("streaming-now"),e.host.appendChild(l.dom),l}(e.editor,t,t,""===t.trim());d(n)}e.node.scrollIntoView({behavior:"smooth",block:"center"})}),[e,t]),(0,c.useEffect)((()=>{(async()=>{try{m(n)}catch(e){console.error("Error generating code stream:",e),_(!0),L(),w("Error generating code. Please try again.")}})()}),[n]),(0,c.useEffect)((()=>(u&&(async()=>{N.current=!1,I.current=setTimeout((()=>{N.current||(_(!0),L(),w("Error: Server took too long to respond. Please try again."))}),3e4);try{for await(const e of u)N.current||(N.current=!0,I.current&&(clearTimeout(I.current),I.current=null),w("Writing...")),E((t=>t+e));_(!0),N.current&&w("")}catch(e){console.error("Error processing stream:",e),_(!0),!I.current&&N.current?w("Error processing stream."):N.current||I.current||w("Error starting stream.")}finally{I.current&&(clearTimeout(I.current),I.current=null)}})(),()=>{I.current&&(clearTimeout(I.current),I.current=null)})),[u]),(0,c.useEffect)((()=>{k&&s&&(s.dom.classList.remove("streaming-now"),s.dispatch({changes:{from:0,to:s.state.doc.length,insert:b}}))}),[k,s,b]),(0,c.useEffect)((()=>{var n;if(!k&&e&&s){const e=t.split("\n"),o=b.split("\n");if(o.length>1){let t="";t=o.length<e.length?[...o.slice(0,-1),e[o.length-1]+"​",...e.slice(o.length)].join("\n"):b.split("\n").slice(0,-1).join("\n"),s.dispatch({changes:{from:0,to:s.state.doc.length,insert:t}});const r=s.dom.querySelectorAll(".cm-changedLine");r.length>0&&(null===(n=r[r.length-1].previousElementSibling)||void 0===n||n.classList.add("hidden-diff"))}}}),[b,k,e,s,t]);const L=()=>{const t=null==s?void 0:s.dom;t&&t.remove(),e.editor.editor.dom.classList.remove("hidden-editor");const n=S.current;n&&n.remove()};return a().createElement("div",null,x&&!j&&a().createElement("div",{className:"status-container"},!k&&!j&&a().createElement("div",{className:"spinner-container"},a().createElement("div",{className:"spinner-border"}),a().createElement("button",{className:"cancel-button",onClick:()=>{A(!0),_(!0),w(""),m(null),r(),L()},title:"Cancel request"},a().createElement(f.stopIcon.react,null))),a().createElement("p",{className:"status-element"},x)),s&&k&&!j&&a().createElement(y,{buttonsRef:S,onAcceptAndRun:()=>{i(b),L()},onAccept:()=>{o(b),L()},onReject:()=>{r(),L()},onEditPrompt:()=>{l(b),L()}}))};var k=n(987);let _="wss://backend.jovyan-ai.com",x="",w=new k.JovyanClient(_,x,""),S=!1;const j=async e=>{try{const t=await e.load("@jovyanai/labextension:plugin");_=t.get("backendUrl").composite,x=t.get("authToken").composite}catch(e){console.error("Failed to load settings for @jovyanai/labextension:",e)}try{console.debug("Recreating JovyanClient instance with new settings"),w=new k.JovyanClient(_,x,""),await w.connect();const e=await w.startSession();console.debug("Session ID:",e),console.debug("JovyanClient instance created and connected"),S=!0}catch(e){console.error("Failed to create JovyanClient instance:",e)}},A=e=>{const t=[];if("code"===e.model.type){const n=e.model.outputs;for(let e=0;e<n.length;e++){const o=n.get(e);if(o){const e=o.toJSON();switch(e.output_type){case"execute_result":{const n={output_type:"execute_result",data:e.data};t.push(n);break}case"stream":{const n={output_type:"stream",name:String(e.name||"stdout"),text:Array.isArray(e.text)?e.text.map(String):[String(e.text||"")]};t.push(n);break}case"display_data":{const n={output_type:"display_data",data:e.data};t.push(n);break}case"error":{const n={output_type:"error",ename:String(e.ename||"Error"),evalue:String(e.evalue||"Unknown error"),traceback:Array.isArray(e.traceback)?e.traceback.map(String):[]};t.push(n);break}}}}}return{cell_type:e.model.type,source:e.model.sharedModel.source,outputs:t}};class I{constructor(e,t){this.addCellActivateButton=()=>{this.removeAllActivateButtons();let e="Generate";"code"===this._cell.model.type&&this._cell.model.sharedModel.source&&(e="Modify");const t=document.createElement("div"),n=(0,l.H)(t),o=this._cell.node,r=()=>{this.addPromptInput(),t.remove()},c=a().createElement(i,{onClick:r,text:e});n.render(c),o.appendChild(t),o.hasAttribute("jv-activate-listener")||(o.addEventListener("keydown",(e=>{"k"===e.key&&e.metaKey&&(e.preventDefault(),r())})),o.setAttribute("jv-activate-listener","true"))},this._cell=e,this._notebookController=t}removeAllActivateButtons(){const e=document.querySelector(".jv-cell-ai-button-container");e&&e.remove()}removeCellActivateButton(){const e=this._cell.node.querySelector(".jv-cell-ai-button-container");e&&e.remove()}activate(){console.debug("Activating cell",this._cell.node),this.removeAllActivateButtons(),this.addCellActivateButton(),this.addFixErrorButton()}_checkIsErrorCell(){if("code"!==this._cell.model.type)return!1;const e=this._cell.model;if(0===e.sharedModel.outputs.length)return!1;for(const t of e.sharedModel.outputs)if("error"===t.output_type)return!0;return!1}addFixErrorButton(){if("code"!==this._cell.model.type)return;console.debug("Adding fix error button",this._cell.node);const e=this._cell.node.querySelector(".jv-cell-fix-error-container");e&&e.remove();const t=this._cell.node,n=t.querySelector(".jp-Cell-outputArea");if(!n)return;if(!this._checkIsErrorCell())return;const o=document.createElement("div"),r=(0,l.H)(o),c=async()=>{if(!this._checkIsErrorCell())return;this._checkIsErrorCell();const e=await this.createCodeStream("Fix this error");this.addDiffReview(e),o.remove()},i=a().createElement(s,{onClick:c,text:"Fix Error"});r.render(i),n.appendChild(o),t.hasAttribute("jv-fix-error-listener")||(t.addEventListener("keydown",(e=>{"F"===e.key&&e.shiftKey&&(e.preventDefault(),c())})),t.setAttribute("jv-fix-error-listener","true"))}addPromptInput(){if(this._cell.node.querySelector(".jv-cell-ai-input-container"))return void console.debug("Input container already exists, skipping add.");console.debug("Creating input container for cell:",this._cell.id);const e=document.createElement("div");e.style.position="relative",e.style.marginTop="10px",e.tabIndex=-1,e.style.outline="none";const t=a().createElement(m,{isEnabled:!0,placeholderEnabled:"Ask Jovyan",placeholderDisabled:"Input disabled",onSubmit:async e=>{const t=await this.createCodeStream(e);this.addDiffReview(t),this.removePromptInput()},onCancel:()=>{console.debug("Prompt cancelled"),e.remove(),this.addCellActivateButton()}});(0,l.H)(e).render(t),this._notebookController.addElementAfterCellInput(this._cell,e),setTimeout((()=>{try{e.focus()}catch(e){console.error("Error focusing inputContainer:",e)}try{e.scrollIntoView({behavior:"smooth",block:"nearest"})}catch(e){console.error("Error scrolling inputContainer:",e)}}),0)}removePromptInput(){const e=this._cell.node.querySelector(".jv-cell-ai-input-container");e&&e.remove()}createCodeStream(e){return(async e=>{const t=await(async()=>{if(!w)throw new Error("JovyanClient instance not initialized");if(!S)try{await w.connect();const e=await w.startSession();console.debug("Session ID:",e),console.debug("JovyanClient instance created and connected"),S=!0}catch(e){console.error("Failed to create JovyanClient instance:",e)}return w})();let n=!1;const o=[];return t.generateCodeStream({currentCell:A(e.currentCell),previousCells:e.previousCells.map(A),nextCells:e.nextCells.map(A),prompt:e.userInput,language:e.language,stream:!0},(e=>{o.push(e)})).then((()=>{n=!0})).catch((e=>{throw console.error("Error generating code stream:",e),e})),async function*(){for(;!n||o.length>0;)if(o.length>0){const e=o.shift();e&&(yield e)}else await new Promise((e=>setTimeout(e,50)))}()})({currentCell:this._cell,previousCells:this._notebookController.getPreviousCells(this._cell),nextCells:this._notebookController.getNextCells(this._cell),userInput:e,language:this._notebookController.getLanguage()})}addDiffReview(e){const t=document.createElement("div"),n=(0,l.H)(t),o=a().createElement(E,{activeCell:this._cell,oldCode:this._cell.model.sharedModel.source,generateCodeStream:e,acceptCodeHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this.activate()},rejectCodeHandler:()=>{this.activate()},editPromptHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this.addPromptInput()},acceptAndRunHandler:e=>{this._notebookController.writeCodeInCell(this._cell,e),this._notebookController.runCell(this._cell),this.activate(),this._notebookController.insertCell(this._notebookController.currentCellIndex+1)}});n.render(o),this._notebookController.addElementAfterCellInput(this._cell,t)}}class N{constructor(e,t){this._notebookTracker=e,this._commands=t}get activeCell(){var e;return null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell}addElementAfterCellInput(e,t){const n=e.node,o=n.querySelector(".jp-Cell-inputWrapper");o?o.insertAdjacentElement("afterend",t):n.appendChild(t)}addElementInCellChild(e,t){e.node.appendChild(t)}writeCodeInCell(e,t){e.model.sharedModel.setSource(t)}runCell(e){const t=this._notebookTracker.currentWidget;t&&(t.content.activeCellIndex=t.content.widgets.indexOf(e),this._commands.execute("notebook:run-cell"))}insertCell(e,t){var n;const o=this._notebookTracker.currentWidget;o&&(null===(n=o.model)||void 0===n||n.sharedModel.insertCell(e,{cell_type:"code",source:t}))}get currentCell(){var e;return null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCell}get currentCellIndex(){var e;return(null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.content.activeCellIndex)||0}getPreviousCells(e){var t;const n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content,o=null==n?void 0:n.activeCellIndex;return void 0!==o&&n?n.widgets.slice(0,o):[]}getNextCells(e){var t;const n=null===(t=this._notebookTracker.currentWidget)||void 0===t?void 0:t.content,o=this.currentCellIndex;return void 0!==o&&n?n.widgets.slice(o+1):[]}getLanguage(){var e;const t=null===(e=this._notebookTracker.currentWidget)||void 0===e?void 0:e.model;return(null==t?void 0:t.defaultKernelLanguage)||"python"}runCommand(e){this._commands.execute(e)}}const L={id:"@jovyanai/labextension:plugin",description:"A JupyterLab extension to integrate Jovyan AI",autoStart:!0,requires:[o.INotebookTracker],optional:[r.ISettingRegistry],activate:async(e,t,n)=>{console.debug("JupyterLab extension @jovyanai/labextension is activated! Hello!"),n&&(await j(n),n.load("@jovyanai/labextension:plugin").then((e=>{e.changed.connect((async()=>{await j(n)}))})).catch((e=>{console.error("Failed to load settings for @jovyanai/labextension:",e)})));const r=new N(t,e.commands);t.activeCellChanged.connect(((e,t)=>{t&&new I(t,r).activate()})),o.NotebookActions.executed.connect(((e,t)=>{const n=t.cell;console.debug("Cell executed",n),n&&new I(n,r).addFixErrorButton()}))}}}}]);