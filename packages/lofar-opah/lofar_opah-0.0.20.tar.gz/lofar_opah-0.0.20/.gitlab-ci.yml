default:
  image: $CI_REGISTRY_IMAGE/ci-build-runner:$CI_COMMIT_REF_SLUG
  cache:
    paths:
      - .cache/pip
      # Do not cache .tox, to recreate virtualenvs for every step

stages:
  - prepare
  - lint
  - test
  - package
  - images
  - publish # publish instead of deploy
  - render
  - deploy

# Caching of dependencies to speed up builds
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

.python_before:
  before_script:
    - python --version # For debugging

# Prepare image to run ci on
trigger_prepare:
  stage: prepare
  trigger:
    strategy: depend
    include: .prepare.gitlab-ci.yml

run_black:
  stage: lint
  extends: .python_before
  script:
    - tox -e black
  allow_failure: true

run_flake8:
  stage: lint
  extends: .python_before
  script:
    - tox -e pep8
  allow_failure: true

run_pylint:
  stage: lint
  extends: .python_before
  script:
    - tox -e pylint
  allow_failure: true

sast:
  variables:
    SAST_EXCLUDED_ANALYZERS: brakeman, flawfinder, kubesec, nodejs-scan, phpcs-security-audit,
      pmd-apex, security-code-scan, sobelow, spotbugs
  stage: test

dependency_scanning:
  variables:
    PIP_EXTRA_INDEX_URL: https://git.astron.nl/api/v4/groups/36/-/packages/pypi/simple
    

# Basic setup for all Python versions for which we don't have a base image
.run_unit_test_version_base:
  before_script:
    - python --version # For debugging
    - python -m pip install --upgrade pip
    - python -m pip install --upgrade tox twine

# Run all unit tests for Python versions except the base image
run_unit_tests:
  needs: []
  extends: .run_unit_test_version_base
  stage: test
  image: python:3.13
  artifacts:
    reports:
      junit: lofar_opah_report.xml
  script:
    - tox -e py313
  
# Run code coverage on the base image thus also performing unit tests
run_unit_tests_coverage:
  stage: test
  extends: .python_before
  script:
   - tox -e coverage
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: lofar_opah_report.xml
    paths:
      - htmlcov/*

package_files:
  stage: package
  needs: []
  extends: .python_before
  artifacts:
    expire_in: 1w
    paths:
      - dist/*
  script:
    - tox -e build

package_docs:
  stage: package
  needs: 
    - trigger_prepare
  extends: .python_before
  artifacts:
    expire_in: 1w
    paths:
      - docs/build/*
  script:
    - tox -e docs

docker_build:
  stage: images
  image: docker:latest
  needs:
    - package_files
  tags:
    - dind
  before_script: []
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -f docker/opah/Dockerfile . --build-arg BUILD_ENV=copy --tag $CI_REGISTRY_IMAGE/opah:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE/opah:$CI_COMMIT_REF_SLUG

publish_on_gitlab:
  stage: publish
  environment: gitlab
  needs:
    - package_files
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "run twine for gitlab"
    - |
      TWINE_PASSWORD=${CI_JOB_TOKEN} \
      TWINE_USERNAME=gitlab-ci-token \
      python -m twine upload \
      --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*

publish_on_test_pypi:
  stage: publish
  environment: pypi-test
  allow_failure: true
  needs:
    - package_files
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED == "true"'
  script:
    - echo "run twine for test pypi"
    # - |
    #   TWINE_PASSWORD=${PIPY_TOKEN} \
    #   TWINE_USERNAME=${PIPY_USERNAME} \
    # TODO: replace URL with a pipy URL
    #   python -m twine upload \
    #   --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
    - exit 1

publish_on_pypi:
  stage: publish
  environment: pypi
  needs:
    - package_files
  when: manual
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED == "true"'
  script:
    - echo "run twine for pypi"
    - |
      TWINE_PASSWORD="${PYPI_TOKEN}" \
      TWINE_USERNAME="__token__" \
      python -m twine upload dist/*

publish_to_readthedocs:
  stage: publish
  allow_failure: true
  environment: readthedocs
  needs:
    - package_docs
  when: manual
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED == "true"'
  script:
    - echo "scp docs/* ???"
    - exit 1

release_job:
  stage: publish
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED == "true"'
  script:
    - echo "running release_job"
  release:
    tag_name: '$CI_COMMIT_TAG'
    description: '$CI_COMMIT_TAG - $CI_COMMIT_TAG_MESSAGE'

.components:
  parallel:
    matrix:
      - COMPONENT:
          - control-restapi-server
          - grafana-rpc-server
  
render_levant_central:
  extends: .components
  stage: render
  image:
    name: hashicorp/levant
    entrypoint: [ "" ]
  script:
    - |
      levant render \
        -var-file=infra/env/stations.yaml \
        -var image_tag="$CI_COMMIT_REF_SLUG" \
        infra/jobs/central/${COMPONENT}.levant.nomad > ${COMPONENT}.nomad
  
      # make sure all variables are filled in,
      # see also https://github.com/hashicorp/levant/pull/308
      ! fgrep "<no value>" ${COMPONENT}.nomad
  artifacts:
    paths:
      - ${COMPONENT}.nomad


deploy_nomad_central:
  extends: .components
  stage: deploy
  image:
    name: hashicorp/nomad
    entrypoint: [ "" ]
  when: manual
  needs:
    - docker_build
    - render_levant_central
  dependencies:
    - render_levant_central
  rules:
     - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) || $CI_COMMIT_TAG
  environment:
    name: central
  script:
    - |
      nomad job run -address="http://nomad.central.lofar.net:4646" ${COMPONENT}.nomad

deploy_nomad_station:
  stage: deploy
  rules:
    - if: ($CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH) || $CI_COMMIT_TAG
  when: manual
  needs:
    - docker_build
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
  trigger:
    include: .deploy.gitlab-ci.yml
    forward:
      pipeline_variables: true
  parallel:
    matrix:
      - STATION:
          - cs001
          - cs032
          - rs307
          - dts-lab
