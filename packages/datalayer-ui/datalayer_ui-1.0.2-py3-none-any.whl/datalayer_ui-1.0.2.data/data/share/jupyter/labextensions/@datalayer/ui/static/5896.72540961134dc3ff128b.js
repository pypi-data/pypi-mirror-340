"use strict";(self.webpackChunk_datalayer_ui=self.webpackChunk_datalayer_ui||[]).push([[5896],{75896:(e,t,n)=>{n.r(t),n.d(t,{ForkManager:()=>K,IForkManagerToken:()=>J,JUPYTER_COLLABORATION_FORK_EVENTS_URI:()=>q,NotebookCellServerExecutor:()=>l,ROOM_FORK_URL:()=>p,TimelineWidget:()=>B,WebSocketAwarenessProvider:()=>s,WebSocketProvider:()=>w,YDrive:()=>k,requestAPI:()=>m,requestDocSession:()=>g,requestDocumentTimeline:()=>_,requestUndoRedo:()=>y});var o=n(1823);class s extends o.$R{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness,this._user=e.user,this._user.ready.then((()=>this._onUserChanged(this._user))).catch((e=>console.error(e))),this._user.userChanged.connect(this._onUserChanged,this)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._user.userChanged.disconnect(this._onUserChanged,this),this._isDisposed=!0,this.destroy())}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}var r=n(14326),i=n(78635),a=n(55236),c=n(2280);class l{constructor(e){var t;this._serverSettings=null!==(t=e.serverSettings)&&void 0!==t?t:a.ServerConnection.makeSettings()}async runCell({cell:e,notebook:t,notebookConfig:n,onCellExecuted:o,onCellExecutionScheduled:s,sessionContext:l,sessionDialogs:d,translator:h}){var u,p,m;const g=(h=null!=h?h:c.nullTranslator).load("jupyterlab");switch(e.model.type){case"markdown":e.rendered=!0,e.inputHidden=!1,o({cell:e,success:!0});break;case"code":if(l){if(l.isTerminating){await(0,r.showDialog)({title:g.__("Kernel Terminating"),body:g.__("The kernel for %1 appears to be terminating. You can not run any cell for now.",null===(u=l.session)||void 0===u?void 0:u.path),buttons:[r.Dialog.okButton()]});break}if(l.pendingInput)return await(0,r.showDialog)({title:g.__("Cell not executed due to pending input"),body:g.__("The cell has not been executed to avoid kernel deadlock as there is another pending input! Submit your pending input and try again."),buttons:[r.Dialog.okButton()]}),!1;if(l.hasNoKernel&&await l.startKernel()&&d&&await d.selectKernel(l),l.hasNoKernel)return e.model.sharedModel.transact((()=>{e.model.clearExecution()})),!0;const n=null===(m=null===(p=null==l?void 0:l.session)||void 0===p?void 0:p.kernel)||void 0===m?void 0:m.id,c=i.URLExt.join(this._serverSettings.baseUrl,`api/kernels/${n}/execute`),h=e.model.sharedModel.getId(),_=t.sharedModel.getState("document_id"),y={method:"POST",body:JSON.stringify({cell_id:h,document_id:_})};s({cell:e});let v=!1;try{v=(await a.ServerConnection.makeRequest(c,y,this._serverSettings)).ok}catch(t){if(o({cell:e,success:!1}),e.isDisposed)return!1;throw t}return o({cell:e,success:v}),!0}e.model.sharedModel.transact((()=>{e.model.clearExecution()}),!1)}return Promise.resolve(!0)}}const d="api/collaboration/session",h="api/collaboration/undo_redo",u="api/collaboration/timeline",p="api/collaboration/fork";async function m(e="",t={}){const n=a.ServerConnection.makeSettings(),o=i.URLExt.join(n.baseUrl,e);let s;try{s=await a.ServerConnection.makeRequest(o,t,n)}catch(e){throw new a.ServerConnection.NetworkError(e)}let r=await s.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.error("Not a JSON response body.",s)}if(!s.ok)throw new a.ServerConnection.ResponseError(s,r.message||r);return r}async function g(e,t,n){const o=a.ServerConnection.makeSettings(),s=i.URLExt.join(o.baseUrl,d,encodeURIComponent(n)),r={method:"PUT",body:JSON.stringify({format:e,type:t})};let c;try{c=await a.ServerConnection.makeRequest(s,r,o)}catch(e){throw new a.ServerConnection.NetworkError(e)}let l=await c.text();if(l.length>0)try{l=JSON.parse(l)}catch(e){console.log("Not a JSON response body.",c)}if(!c.ok)throw new a.ServerConnection.ResponseError(c,l.message||l);return l}async function _(e,t,n){const o=a.ServerConnection.makeSettings();let s=i.URLExt.join(o.baseUrl,u,n);s=s.concat(`?format=${e}&&type=${t}`);const r={method:"GET"};let c;try{c=await a.ServerConnection.makeRequest(s,r,o)}catch(e){throw new a.ServerConnection.NetworkError(e)}return c}async function y(e,t,n,o){const s=a.ServerConnection.makeSettings();let r=i.URLExt.join(s.baseUrl,h,encodeURIComponent(e));r=r.concat(`?action=${t}&&steps=${n}&&forkRoom=${o}`);const c={method:"PUT"};let l;try{l=await a.ServerConnection.makeRequest(r,c,s)}catch(e){throw new a.ServerConnection.NetworkError(e)}let d=await l.text();if(d.length>0)try{d=JSON.parse(d)}catch(e){console.log("Not a JSON response body.",l)}if(!l.ok)throw new a.ServerConnection.ResponseError(l,d.message||d);return d}var v=n(74602),f=n(67262);class w{constructor(e){this._onConnectionClosed=e=>{1003===e.code&&(console.error("Document provider closed:",e.reason),(0,r.showErrorMessage)(this._trans.__("Document session error"),e.reason,[r.Dialog.okButton()]),this._sharedModel.dispose())},this._onSync=e=>{e&&(this._yWebsocketProvider&&(this._yWebsocketProvider.off("sync",this._onSync),this._sharedModel.ydoc.getMap("state").set("document_id",this._yWebsocketProvider.roomname)),this._ready.resolve())},this._ready=new f.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}get contentType(){return this._contentType}get format(){return this._format}dispose(){var e,t,n;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(n=this._yWebsocketProvider)||void 0===n||n.destroy(),this._disconnect(),v.Signal.clearData(this))}async reconnect(){this._disconnect(),this._connect()}async _connect(){const e=await g(this._format,this._contentType,this._path);this._yWebsocketProvider=new o.$R(this._serverUrl,`${e.format}:${e.type}:${e.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:e.sessionId},awareness:this._awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)}async connectToForkDoc(e,t){this._disconnect(),this._yWebsocketProvider=new o.$R(this._serverUrl,e,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:t},awareness:this._awareness})}get wsProvider(){return this._yWebsocketProvider}_disconnect(){var e,t,n;null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(n=this._yWebsocketProvider)||void 0===n||n.destroy(),this._yWebsocketProvider=null}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}const S="true"===i.PageConfig.getOption("disableRTC");class k extends a.Drive{constructor(e,t,n){super({name:"RTC"}),this._onCreate=(e,t)=>{var n,o;if("string"==typeof e.format)try{const s=new w({url:i.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),r=((null===(n=this._globalAwareness)||void 0===n?void 0:n.getLocalState())||{}).documents||[];r.includes(e.path)||(r.push(`${this.name}:${e.path}`),null===(o=this._globalAwareness)||void 0===o||o.setLocalStateField("documents",r));const a=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(a,s),t.changed.connect((async(n,o)=>{var s;if(!o.stateChange)return;const r=o.stateChange.filter((e=>"hash"===e.name));if(0===r.length)return;r.length>1&&console.error("Unexpected multiple changes to hash value in a single transaction");const i=r[0],a=null!==(s=t.state.path)&&void 0!==s?s:e.path,c=await this.get(a,{content:!1});this._ydriveFileChanged.emit({type:"save",newValue:{...c,hash:i.newValue},oldValue:{hash:i.oldValue}})})),t.disposed.connect((()=>{var t,n;const o=this._providers.get(a);o&&(o.dispose(),this._providers.delete(a));const s=((null===(t=this._globalAwareness)||void 0===t?void 0:t.getLocalState())||{}).documents||[],r=s.indexOf(`${this.name}:${e.path}`);r>-1&&s.splice(r,1),null===(n=this._globalAwareness)||void 0===n||n.setLocalStateField("documents",s)}))}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._ydriveFileChanged=new v.Signal(this),this._user=e,this._trans=t,this._globalAwareness=n,this._providers=new Map,this.sharedModelFactory=new C(this._onCreate),super.fileChanged.connect(((e,t)=>{this._ydriveFileChanged.emit(t)}))}get providers(){return this._providers}dispose(){this.isDisposed||(this._providers.forEach((e=>e.dispose())),this._providers.clear(),super.dispose())}async get(e,t){if(t&&t.format&&t.type){const n=`${t.format}:${t.type}:${e}`,o=this._providers.get(n);if(o){const[n]=await Promise.all([super.get(e,{...t,content:!1}),o.ready]);return{...n,format:t.format}}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const n=`${t.format}:${t.type}:${e}`;if(this._providers.get(n)){const n={type:t.type,format:t.format,content:!1};return this.get(e,n)}}return super.save(e,t)}get fileChanged(){return this._ydriveFileChanged}}class C{constructor(e){this._onCreate=e,this.collaborative=!S,this.documentFactories=new Map}registerDocumentFactory(e,t){if(this.documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this.documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(this.collaborative&&e.collaborative&&this.documentFactories.has(e.contentType)){const t=this.documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}var b=n(93345),R=n.n(b),E=n(48318),T=n.n(E),U=n(25879),$=n.n(U),D=n(10237),x=n.n(D),N=n(74862),P=n.n(N),j=n(51050),L=n.n(j),I=n(68495),F=n.n(I),M=n(57848),W={};W.styleTagTransform=F(),W.setAttributes=P(),W.insert=x().bind(null,"head"),W.domAPI=$(),W.insertStyleElement=L(),T()(M.A,W),M.A&&M.A.locals&&M.A.locals;var A=n(54250);const O=({apiURL:e,provider:t,contentType:n,format:o,documentTimelineUrl:s})=>{const[i,a]=(0,b.useState)({roomId:"",timestamps:[],forkRoom:"",sessionId:""}),[c,l]=(0,b.useState)(i.timestamps.length-1),[d,h]=(0,b.useState)(!1),[u,p]=(0,b.useState)(!1),m=(0,b.useRef)(!0),v=(0,b.useRef)(!0),f=(0,b.useRef)(null);function w(e){try{const t=new URL(e).pathname,n=t.lastIndexOf(s);if(-1===n)throw new Error(`API segment "${s}" not found in URL.`);return t.slice(n+s.length)}catch(e){return console.error("Invalid URL or unable to extract filename:",e),""}}return R().createElement("div",{className:"jp-sliderContainer"},R().createElement("div",{onClick:()=>{!async function(s){try{if(m.current){const i=await _(o,n,s);if(!i.ok)throw 404===i.status?new Error("Not found"):503===i.status?new Error("WebSocket closed"):new Error(`Failed to fetch data: ${i.statusText}`);const c=await i.text();let d={roomId:"",timestamps:[],forkRoom:"",sessionId:""};return c&&(r.Notification.warning("Document is now in read-only mode. Changes will not be saved.",{autoClose:2500}),d=JSON.parse(c),a(d),l(d.timestamps.length-1),t.connectToForkDoc(d.forkRoom,d.sessionId),f.current=await g(o,n,w(e))),h(!0),m.current=!1,d}}catch(e){console.error("Error fetching data:",e)}}(w(e))},className:"jp-mod-highlighted",title:"Document Timeline"},R().createElement(A.historyIcon.react,{marginRight:"4px"})),d&&R().createElement("div",{className:"jp-timestampDisplay"},R().createElement("input",{type:"range",min:0,max:i.timestamps.length-1,value:c,onChange:async e=>{const t=parseInt(e.target.value),n=Math.abs(t-c);try{const e=function(e){return e<c?"undo":"redo"}(t);if(l(t),v.current&&(p(!0),v.current=!1),!f.current)return void console.error("Session is not initialized");await y(`${f.current.format}:${f.current.type}:${f.current.fileId}`,e,n,i.forkRoom)}catch(e){console.error("Error fetching or applying updates:",e)}},className:"jp-Slider"}),R().createElement("div",null,R().createElement("strong",null,w(e).split("/").pop()," ")," "),u&&R().createElement("div",{className:"jp-restoreBtnContainer"},R().createElement("button",{onClick:async()=>{if(!f.current)return void console.error("Session is not initialized");const e=await y(`${f.current.format}:${f.current.type}:${f.current.fileId}`,"restore",0,i.forkRoom);200===e.code?(r.Notification.success(e.status,{autoClose:4e3}),t.reconnect(),h(!1),m.current=!0):r.Notification.error(e.status,{autoClose:4e3})},className:"jp-ToolbarButtonComponent jp-restoreBtn"},"Restore version"," ",(e=>{const t=new Date(1e3*e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`})(i.timestamps[c])))))};class B extends r.ReactWidget{constructor(e,t,n,o,s){super(),this.apiURL=e,this.provider=t,this.contentType=n,this.format=o,this.documentTimelineUrl=s,this.addClass("jp-timelineSliderWrapper")}render(){return b.createElement(O,{key:this.apiURL,apiURL:this.apiURL,provider:this.provider,contentType:this.contentType,format:this.format,documentTimelineUrl:this.documentTimelineUrl})}updateContent(e,t){this.apiURL=e,this.provider=t,this.contentType=this.provider.contentType,this.format=this.provider.format,this.update()}}const J=new f.Token("@jupyter/docprovider:IForkManagerToken"),q="https://schema.jupyter.org/jupyter_collaboration/fork/v1";class K{constructor(e){this._disposed=!1,this._forkAddedSignal=new v.Signal(this),this._forkDeletedSignal=new v.Signal(this);const{drive:t,eventManager:n}=e;this._drive=t,this._eventManager=n,this._eventManager.stream.connect(this._handleEvent,this)}get isDisposed(){return this._disposed}get forkAdded(){return this._forkAddedSignal}get forkDeleted(){return this._forkDeletedSignal}dispose(){var e;this._disposed||(null===(e=this._eventManager)||void 0===e||e.stream.disconnect(this._handleEvent),this._disposed=!0)}async createFork(e){const{rootId:t,title:n,description:o,synchronize:s}=e,r={method:"PUT",body:JSON.stringify({title:n,description:o,synchronize:s})},a=i.URLExt.join(p,t);return await m(a,r)}async getAllForks(e){const t=i.URLExt.join(p,e);return await m(t,{method:"GET"})}async deleteFork(e){const{forkId:t,merge:n}=e,o=i.URLExt.join(p,t),s=i.URLExt.objectToQueryString({merge:n});await m(`${o}${s}`,{method:"DELETE"})}getProvider(e){const{documentPath:t,format:n,type:o}=e,s=this._drive;if(s){const e=s.name;let r=t;return t.startsWith(e)&&(r=t.slice(e.length+1)),s.providers.get(`${n}:${o}:${r}`)}}_handleEvent(e,t){if(t.schema_id===q)switch(t.action){case"create":this._forkAddedSignal.emit(t);break;case"delete":this._forkDeletedSignal.emit(t)}}}},57848:(e,t,n)=>{n.d(t,{A:()=>a});var o=n(16551),s=n.n(o),r=n(1992),i=n.n(r)()(s());i.push([e.id,"/* -----------------------------------------------------------------------------\n| Copyright (c) Jupyter Development Team.\n| Distributed under the terms of the Modified BSD License.\n|---------------------------------------------------------------------------- */\n\n.jp-timelineSliderWrapper .jp-sliderContainer{\n  display: flex;\n  align-items: center;\n}\n\n.jp-Slider {\n  height: 4.5px\n}\n\n#jp-slider-status-bar {\n  display: flex;\n}\n\n.jp-timestampDisplay {\n  display: flex;\n  flex-direction: row;\n  align-items: center;\n  gap: 6px;\n}\n\n.jp-restoreBtnContainer {\n  width: 192px;\n}\n\n.jp-ToolbarButtonComponent.jp-restoreBtn {\n  cursor: pointer;\n  color: var(--jp-layout-color2);\n  width: 100%;\n  background: var(--jp-accept-color-normal)\n}\n",""]);const a=i}}]);